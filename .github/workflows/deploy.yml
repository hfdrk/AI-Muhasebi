name: Deploy

on:
  push:
    branches:
      - main
      - staging
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: "18"
  PNPM_VERSION: "8.15.0"

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
    steps:
      - id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: determine-environment
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        if: needs.determine-environment.outputs.environment == 'production'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push backend-api
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/backend-api/Dockerfile
          push: ${{ needs.determine-environment.outputs.environment == 'production' }}
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/backend-api:${{ needs.determine-environment.outputs.environment }}
            ${{ secrets.DOCKER_REGISTRY }}/backend-api:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push web-app
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web-app/Dockerfile
          push: ${{ needs.determine-environment.outputs.environment == 'production' }}
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/web-app:${{ needs.determine-environment.outputs.environment }}
            ${{ secrets.DOCKER_REGISTRY }}/web-app:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build and push worker-jobs
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/worker-jobs/Dockerfile
          push: ${{ needs.determine-environment.outputs.environment == 'production' }}
          tags: |
            ${{ secrets.DOCKER_REGISTRY }}/worker-jobs:${{ needs.determine-environment.outputs.environment }}
            ${{ secrets.DOCKER_REGISTRY }}/worker-jobs:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [determine-environment, build-and-push]
    if: github.event_name != 'pull_request'
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH to ${{ needs.determine-environment.outputs.environment }}
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e
            cd ${{ secrets.DEPLOY_APP_DIR || '/opt/ai-muhasebi' }}
            echo "==> Pulling latest Docker images..."
            docker compose pull
            echo "==> Starting updated containers..."
            docker compose up -d --remove-orphans
            echo "==> Waiting 10s for services to start..."
            sleep 10
            echo "==> Health check..."
            curl -sf http://localhost:3800/healthz || exit 1
            echo "==> Running pending Prisma migrations..."
            docker compose exec -T backend-api npx prisma migrate deploy
            echo "==> Pruning old Docker images..."
            docker image prune -f
            echo "==> Deployment complete!"

      - name: Post-deploy notification
        if: always()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: deploy-notification
          client-payload: '{"environment": "${{ needs.determine-environment.outputs.environment }}", "status": "${{ job.status }}", "sha": "${{ github.sha }}", "ref": "${{ github.ref }}", "actor": "${{ github.actor }}"}'

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e
            cd ${{ secrets.DEPLOY_APP_DIR || '/opt/ai-muhasebi' }}
            echo "==> Deployment failed, rolling back..."
            docker compose up -d --remove-orphans
            echo "==> Rollback complete (using previous cached images)"
