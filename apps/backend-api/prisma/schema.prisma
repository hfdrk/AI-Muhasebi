// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique @db.VarChar(255)
  hashedPassword String    @map("hashed_password") @db.VarChar(255)
  fullName       String    @map("full_name") @db.VarChar(255)
  locale         String    @default("tr-TR") @db.VarChar(10)
  isActive       Boolean   @default(true) @map("is_active")
  platformRole   String?   @map("platform_role") @db.VarChar(50) // PLATFORM_ADMIN, PLATFORM_SUPPORT
  lastLoginAt    DateTime? @map("last_login_at") @db.Timestamptz(6)
  metadata       Json?     @default("{}")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  memberships             UserTenantMembership[]
  auditLogs               AuditLog[]
  userSettings            UserSettings?
  uploadedDocuments       Document[]
  resolvedRiskAlerts      RiskAlert[]
  passwordResetTokens     PasswordResetToken[]
  createdReportExecutions ReportExecutionLog[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  savedFilters            SavedFilter[]
  assignedTasks           Task[]
  messageThreads          MessageThreadParticipant[]
  sentMessages            Message[]
  createdMasakReports     MasakReport[]       @relation("MasakReportCreatedBy")
  reviewedMasakReports    MasakReport[]       @relation("MasakReportReviewedBy")
  respondedKurganSignals  KurganSignal[]
  generatedBaBsForms      BaBsForm[]
  preparedBeyannameler    Beyanname[]         @relation("BeyannamePreparedBy")
  reviewedBeyannameler    Beyanname[]         @relation("BeyannameReviewedBy")

  @@index([email])
  @@map("users")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(100)
  taxNumber String?  @map("tax_number") @db.VarChar(50)
  phone     String?  @db.VarChar(50)
  email     String?  @db.VarChar(255)
  address   String?  @db.Text
  status    String   @default("ACTIVE") @db.VarChar(50) // ACTIVE, SUSPENDED
  settings  Json?    @default("{}")
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  memberships             UserTenantMembership[]
  auditLogs               AuditLog[]
  tenantSettings          TenantSettings?
  clientCompanies         ClientCompany[]
  invoices                Invoice[]
  transactions            Transaction[]
  ledgerAccounts          LedgerAccount[]
  bankAccounts            ClientCompanyBankAccount[]
  invoiceLines            InvoiceLine[]
  transactionLines        TransactionLine[]
  documents               Document[]
  documentProcessingJobs  DocumentProcessingJob[]
  documentOCRResults      DocumentOCRResult[]
  documentParsedData      DocumentParsedData[]
  documentRiskFeatures    DocumentRiskFeatures[]
  riskRules               RiskRule[]
  documentRiskScores      DocumentRiskScore[]
  clientCompanyRiskScores ClientCompanyRiskScore[]
  riskScoreHistory        RiskScoreHistory[]
  riskAlerts              RiskAlert[]
  tenantIntegrations      TenantIntegration[]
  integrationSyncJobs     IntegrationSyncJob[]
  integrationSyncLogs     IntegrationSyncLog[]
  scheduledReports        ScheduledReport[]
  reportExecutionLogs     ReportExecutionLog[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]
  subscription            TenantSubscription?
  usages                  TenantUsage[]
  savedFilters            SavedFilter[]
  tasks                   Task[]
  documentRequirements    DocumentRequirement[]
  retryQueueItems         RetryQueue[]
  MessageThread           MessageThread[]
  emailLogs               EmailLog[]
  documentEmbeddings      DocumentEmbedding[]
  masakReports            MasakReport[]
  kurganSignals           KurganSignal[]
  baBsForms               BaBsForm[]
  beyannameler            Beyanname[]
  maliMusavirProfile      MaliMusavirProfile?
  eDefterLedgers          EDefterLedger[]
  recurringInvoices       RecurringInvoice[]
  checkNotes              CheckNote[]
  exchangeRates           ExchangeRate[]
  paymentReminders        PaymentReminder[]
  cashFlowEntries         CashFlowEntry[]

  @@index([slug])
  @@map("tenants")
}

model UserTenantMembership {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   @db.VarChar(50) // TenantOwner, Accountant, Staff, ReadOnly
  status    String   @default("active") @db.VarChar(50) // active, invited, suspended
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("user_tenant_memberships")
}

model AuditLog {
  id           String   @id @default(cuid())
  tenantId     String?  @map("tenant_id")
  userId       String?  @map("user_id")
  action       String   @db.VarChar(100) // LOGIN_SUCCESS, LOGIN_FAILED, etc.
  resourceType String?  @map("resource_type") @db.VarChar(100)
  resourceId   String?  @map("resource_id") @db.VarChar(255)
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model TenantSettings {
  id                  String   @id @default(cuid())
  tenantId            String   @unique @map("tenant_id")
  displayName         String?  @map("display_name") @db.VarChar(255)
  logoUrl             String?  @map("logo_url") @db.VarChar(500)
  locale              String   @default("tr-TR") @db.VarChar(10)
  timezone            String   @default("Europe/Istanbul") @db.VarChar(50)
  emailFromName       String?  @map("email_from_name") @db.VarChar(255)
  riskThresholds      Json     @default("{\"high\":70,\"critical\":90}") @map("risk_thresholds")
  defaultReportPeriod String   @default("LAST_30_DAYS") @map("default_report_period") @db.VarChar(50)
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

model UserSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique @map("user_id")
  locale                    String?  @db.VarChar(10)
  timezone                  String?  @db.VarChar(50)
  emailNotificationsEnabled Boolean  @default(true) @map("email_notifications_enabled")
  inAppNotificationsEnabled Boolean  @default(true) @map("in_app_notifications_enabled")
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model ClientCompany {
  id                  String    @id @default(cuid())
  tenantId            String    @map("tenant_id")
  name                String    @db.VarChar(255)
  legalType           String    @map("legal_type") @db.VarChar(50) // Şahıs, Limited, Anonim
  taxNumber           String    @map("tax_number") @db.VarChar(50)
  tradeRegistryNumber String?   @map("trade_registry_number") @db.VarChar(50)
  sector              String?   @db.VarChar(255)
  contactPersonName   String?   @map("contact_person_name") @db.VarChar(255)
  contactPhone        String?   @map("contact_phone") @db.VarChar(50)
  contactEmail        String?   @map("contact_email") @db.VarChar(255)
  address             String?   @db.Text
  startDate           DateTime? @map("start_date") @db.Timestamptz(6)
  isActive            Boolean   @default(true) @map("is_active")
  metadata            Json?     @default("{}")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant               Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankAccounts         ClientCompanyBankAccount[]
  invoices             Invoice[]
  transactions         Transaction[]
  documents            Document[]
  riskScores           ClientCompanyRiskScore[]
  riskAlerts           RiskAlert[]
  tenantIntegrations   TenantIntegration[]
  integrationSyncJobs  IntegrationSyncJob[]
  scheduledReports     ScheduledReport[]
  tasks                Task[]
  documentRequirements DocumentRequirement[]
  messageThreads       MessageThread[]
  masakReports         MasakReport[]
  kurganSignals        KurganSignal[]
  baBsForms            BaBsForm[]
  beyannameler         Beyanname[]
  eDefterLedgers       EDefterLedger[]
  recurringInvoices    RecurringInvoice[]
  checkNotes           CheckNote[]
  paymentReminders     PaymentReminder[]
  cashFlowEntries      CashFlowEntry[]

  @@unique([tenantId, taxNumber])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("client_companies")
}

model ClientCompanyBankAccount {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  clientCompanyId String   @map("client_company_id")
  bankName        String   @map("bank_name") @db.VarChar(255)
  iban            String   @db.VarChar(34)
  accountNumber   String?  @map("account_number") @db.VarChar(50)
  currency        String   @default("TRY") @db.VarChar(3)
  isPrimary       Boolean  @default(false) @map("is_primary")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientCompanyId])
  @@map("client_company_bank_accounts")
}

model Invoice {
  id                    String    @id @default(cuid())
  tenantId              String    @map("tenant_id")
  clientCompanyId       String    @map("client_company_id")
  externalId            String?   @map("external_id") @db.VarChar(255)
  type                  String    @db.VarChar(50) // SATIŞ, ALIŞ
  issueDate             DateTime  @map("issue_date") @db.Timestamptz(6)
  dueDate               DateTime? @map("due_date") @db.Timestamptz(6)
  totalAmount           Decimal   @map("total_amount") @db.Decimal(15, 2)
  currency              String    @default("TRY") @db.VarChar(3)
  taxAmount             Decimal   @map("tax_amount") @db.Decimal(15, 2)
  netAmount             Decimal?  @map("net_amount") @db.Decimal(15, 2)
  counterpartyName      String?   @map("counterparty_name") @db.VarChar(255)
  counterpartyTaxNumber String?   @map("counterparty_tax_number") @db.VarChar(50)
  status                String    @default("taslak") @db.VarChar(50) // taslak, kesildi, iptal, muhasebeleştirilmiş
  source                String    @default("manual") @db.VarChar(50) // manual, import, integration
  metadata              Json?     @default("{}")
  pushedAt              DateTime? @map("pushed_at") @db.Timestamptz(6) // Last time this invoice was pushed to external system
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany    ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  lines            InvoiceLine[]
  relatedDocuments Document[]
  paymentReminders PaymentReminder[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([tenantId, issueDate])
  @@index([tenantId, status])
  @@map("invoices")
}

model InvoiceLine {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  invoiceId   String   @map("invoice_id")
  lineNumber  Int      @map("line_number")
  description String   @db.VarChar(500)
  quantity    Decimal  @db.Decimal(15, 3)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(15, 2)
  lineTotal   Decimal  @map("line_total") @db.Decimal(15, 2)
  vatRate     Decimal  @map("vat_rate") @db.Decimal(5, 4) // e.g. 0, 0.01, 0.18
  vatAmount   Decimal  @map("vat_amount") @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@map("invoice_lines")
}

model LedgerAccount {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  code      String   @db.VarChar(50)
  name      String   @db.VarChar(255)
  type      String   @db.VarChar(50) // asset, liability, equity, income, expense
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactionLines TransactionLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("ledger_accounts")
}

model Transaction {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  clientCompanyId String?  @map("client_company_id")
  externalId      String?  @map("external_id") @db.VarChar(255)
  date            DateTime @db.Timestamptz(6)
  referenceNo     String?  @map("reference_no") @db.VarChar(100)
  description     String?  @db.Text
  source          String   @default("manual") @db.VarChar(50) // manual, import, integration
  pushedAt        DateTime? @map("pushed_at") @db.Timestamptz(6) // Last time this transaction was pushed to external system
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany    ClientCompany?    @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  lines            TransactionLine[]
  relatedDocuments Document[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([tenantId, date])
  @@index([tenantId, externalId])
  @@map("transactions")
}

model TransactionLine {
  id              String   @id @default(cuid())
  tenantId        String   @map("tenant_id")
  transactionId   String   @map("transaction_id")
  ledgerAccountId String   @map("ledger_account_id")
  debitAmount     Decimal  @map("debit_amount") @db.Decimal(15, 2)
  creditAmount    Decimal  @map("credit_amount") @db.Decimal(15, 2)
  description     String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transaction   Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  ledgerAccount LedgerAccount @relation(fields: [ledgerAccountId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([transactionId])
  @@index([ledgerAccountId])
  @@map("transaction_lines")
}

model Document {
  id                     String    @id @default(cuid())
  tenantId               String    @map("tenant_id")
  clientCompanyId        String    @map("client_company_id")
  relatedInvoiceId       String?   @map("related_invoice_id")
  relatedTransactionId   String?   @map("related_transaction_id")
  type                   String    @db.VarChar(50) // INVOICE, BANK_STATEMENT, RECEIPT, OTHER
  originalFileName       String    @map("original_file_name") @db.VarChar(500)
  storagePath            String    @map("storage_path") @db.VarChar(1000)
  mimeType               String    @map("mime_type") @db.VarChar(100)
  fileSizeBytes          BigInt    @map("file_size_bytes")
  uploadUserId           String    @map("upload_user_id")
  uploadSource           String    @default("manual") @map("upload_source") @db.VarChar(50) // manual, email_import, integration
  status                 String    @default("UPLOADED") @db.VarChar(50) // UPLOADED, PROCESSING, PROCESSED, FAILED
  processingErrorMessage String?   @map("processing_error_message") @db.Text
  processedAt            DateTime? @map("processed_at") @db.Timestamptz(6)
  isDeleted              Boolean   @default(false) @map("is_deleted")
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant               Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany        ClientCompany          @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  relatedInvoice       Invoice?               @relation(fields: [relatedInvoiceId], references: [id], onDelete: SetNull)
  relatedTransaction   Transaction?           @relation(fields: [relatedTransactionId], references: [id], onDelete: SetNull)
  uploadUser           User                   @relation(fields: [uploadUserId], references: [id], onDelete: Restrict)
  processingJob        DocumentProcessingJob?
  ocrResult            DocumentOCRResult?
  parsedData           DocumentParsedData?
  riskFeatures         DocumentRiskFeatures?
  riskScore            DocumentRiskScore?
  riskAlerts           RiskAlert[]
  documentRequirements DocumentRequirement[]
  embedding            DocumentEmbedding?

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([tenantId, status])
  @@index([tenantId, isDeleted])
  @@index([tenantId, clientCompanyId, isDeleted])
  @@map("documents")
}

model DocumentProcessingJob {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  documentId       String    @unique @map("document_id")
  status           String    @default("PENDING") @db.VarChar(50) // PENDING, IN_PROGRESS, SUCCESS, FAILED
  attemptsCount    Int       @default(0) @map("attempts_count")
  lastErrorMessage String?   @map("last_error_message") @db.Text
  lastAttemptAt    DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, status])
  @@map("document_processing_jobs")
}

model DocumentOCRResult {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  documentId String   @unique @map("document_id")
  rawText    String   @map("raw_text") @db.Text
  ocrEngine  String   @map("ocr_engine") @db.VarChar(50) // stub, tesseract, textract, vision
  confidence Decimal? @map("confidence") @db.Decimal(5, 4)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@map("document_ocr_results")
}

model DocumentParsedData {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  documentId    String   @unique @map("document_id")
  documentType  String   @map("document_type") @db.VarChar(50) // invoice, bank_statement, receipt, unknown
  fields        Json     @default("{}")
  parserVersion String   @map("parser_version") @db.VarChar(50) // 1.0-stub, 2.0-llm
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, documentType])
  @@map("document_parsed_data")
}

model DocumentRiskFeatures {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  documentId  String   @unique @map("document_id")
  features    Json     @default("{}")
  riskFlags   Json     @default("[]")
  riskScore   Decimal? @map("risk_score") @db.Decimal(5, 2)
  generatedAt DateTime @map("generated_at") @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, riskScore])
  @@map("document_risk_features")
}

model DocumentEmbedding {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  documentId String   @unique @map("document_id")
  embedding  Unsupported("vector(1536)") // pgvector - dimensions configurable
  model      String   @db.VarChar(100) // openai:text-embedding-3-small, anthropic:claude-embed, ollama:llama2
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, model])
  @@map("document_embeddings")
}

model RiskRule {
  id              String   @id @default(cuid())
  tenantId        String?  @map("tenant_id")
  scope           String   @db.VarChar(50) // document, company
  code            String   @db.VarChar(100)
  description     String   @db.VarChar(500)
  weight          Decimal  @db.Decimal(5, 2)
  isActive        Boolean  @default(true) @map("is_active")
  defaultSeverity String   @map("default_severity") @db.VarChar(50) // low, medium, high
  config          Json?    @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([scope])
  @@index([isActive])
  @@map("risk_rules")
}

model DocumentRiskScore {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  documentId         String   @unique @map("document_id")
  score              Decimal  @db.Decimal(5, 2) // 0-100
  severity           String   @db.VarChar(50) // low, medium, high
  triggeredRuleCodes Json     @default("[]") // Array of rule codes
  generatedAt        DateTime @map("generated_at") @db.Timestamptz(6)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([severity])
  @@index([tenantId, severity])
  @@index([generatedAt])
  @@map("document_risk_scores")
}

model ClientCompanyRiskScore {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  clientCompanyId    String   @map("client_company_id")
  score              Decimal  @db.Decimal(5, 2) // 0-100
  severity           String   @db.VarChar(50) // low, medium, high
  triggeredRuleCodes Json     @default("[]") // Array of rule codes
  generatedAt        DateTime @map("generated_at") @db.Timestamptz(6)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([severity])
  @@index([tenantId, severity])
  @@index([generatedAt])
  @@map("client_company_risk_scores")
}

model RiskScoreHistory {
  id         String   @id @default(cuid())
  tenantId   String   @map("tenant_id")
  entityType String   @map("entity_type") @db.VarChar(50) // "document" or "company"
  entityId   String   @map("entity_id")
  score      Decimal  @db.Decimal(5, 2) // 0-100
  severity   String   @db.VarChar(50) // low, medium, high
  recordedAt DateTime @map("recorded_at") @db.Timestamptz(6)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([tenantId, entityType, entityId])
  @@index([recordedAt])
  @@index([tenantId, recordedAt])
  @@map("risk_score_history")
}

model RiskAlert {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  clientCompanyId  String?   @map("client_company_id")
  documentId       String?   @map("document_id")
  type             String    @db.VarChar(100) // RISK_THRESHOLD_EXCEEDED, ANOMALY_DETECTED
  title            String    @db.VarChar(255)
  message          String    @db.Text
  severity         String    @db.VarChar(50) // low, medium, high, critical
  status           String    @default("open") @db.VarChar(50) // open, in_progress, closed, ignored
  resolvedAt       DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolvedByUserId String?   @map("resolved_by_user_id")
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  document      Document?      @relation(fields: [documentId], references: [id], onDelete: SetNull)
  resolvedBy    User?          @relation(fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([documentId])
  @@index([status])
  @@index([severity])
  @@index([tenantId, status])
  @@index([tenantId, severity])
  @@index([createdAt])
  @@map("risk_alerts")
}

model IntegrationProvider {
  id           String   @id @default(cuid())
  type         String   @db.VarChar(50) // accounting, bank
  code         String   @unique @db.VarChar(100)
  name         String   @db.VarChar(255)
  description  String?  @db.Text
  isActive     Boolean  @default(true) @map("is_active")
  configSchema Json?    @map("config_schema")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenantIntegrations TenantIntegration[]

  @@index([type])
  @@index([isActive])
  @@map("integration_providers")
}

model TenantIntegration {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  clientCompanyId String?   @map("client_company_id")
  providerId      String    @map("provider_id")
  status          String    @default("disconnected") @db.VarChar(50) // disconnected, connected, error
  displayName     String    @map("display_name") @db.VarChar(255)
  config          Json      @default("{}")
  lastSyncAt      DateTime? @map("last_sync_at") @db.Timestamptz(6)
  lastSyncStatus  String?   @map("last_sync_status") @db.VarChar(50) // success, error, in_progress
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany?       @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  provider      IntegrationProvider  @relation(fields: [providerId], references: [id], onDelete: Restrict)
  syncJobs      IntegrationSyncJob[]
  syncLogs      IntegrationSyncLog[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([providerId])
  @@index([tenantId, status])
  @@map("tenant_integrations")
}

model IntegrationSyncJob {
  id                  String    @id @default(cuid())
  tenantId            String    @map("tenant_id")
  clientCompanyId     String?   @map("client_company_id")
  tenantIntegrationId String    @map("tenant_integration_id")
  jobType             String    @map("job_type") @db.VarChar(50) // pull_invoices, pull_bank_transactions
  status              String    @default("pending") @db.VarChar(50) // pending, in_progress, success, failed
  startedAt           DateTime? @map("started_at") @db.Timestamptz(6)
  finishedAt          DateTime? @map("finished_at") @db.Timestamptz(6)
  errorMessage        String?   @map("error_message") @db.Text
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany     ClientCompany?    @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  tenantIntegration TenantIntegration @relation(fields: [tenantIntegrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantIntegrationId])
  @@index([tenantId, status])
  @@index([status])
  @@map("integration_sync_jobs")
}

model IntegrationSyncLog {
  id                  String   @id @default(cuid())
  tenantId            String   @map("tenant_id")
  tenantIntegrationId String   @map("tenant_integration_id")
  level               String   @db.VarChar(50) // info, warning, error
  message             String   @db.Text
  context             Json?    @default("{}")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantIntegration TenantIntegration @relation(fields: [tenantIntegrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantIntegrationId])
  @@index([tenantId, tenantIntegrationId])
  @@index([level])
  @@index([createdAt])
  @@map("integration_sync_logs")
}

model ReportDefinition {
  id          String   @id @default(cuid())
  code        String   @unique @db.VarChar(100)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive])
  @@map("report_definitions")
}

model ScheduledReport {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  reportCode      String    @map("report_code") @db.VarChar(100)
  clientCompanyId String?   @map("client_company_id")
  name            String    @db.VarChar(255)
  format          String    @db.VarChar(50) // "pdf" | "excel" (string for now)
  scheduleCron    String    @map("schedule_cron") @db.VarChar(100) // "daily" | "weekly" | "monthly" or cron-like
  filters         Json?     @default("{}")
  recipients      Json?     @default("[]") // array of emails
  isActive        Boolean   @default(true) @map("is_active")
  lastRunAt       DateTime? @map("last_run_at") @db.Timestamptz(6)
  lastRunStatus   String?   @map("last_run_status") @db.VarChar(50) // "success" | "failed" | null
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany?       @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  executionLogs ReportExecutionLog[]

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([reportCode])
  @@map("scheduled_reports")
}

model ReportExecutionLog {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  scheduledReportId String?   @map("scheduled_report_id")
  reportCode        String    @map("report_code") @db.VarChar(100)
  startedAt         DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  finishedAt        DateTime? @map("finished_at") @db.Timestamptz(6)
  status            String    @db.VarChar(50) // "success" | "failed"
  message           String?   @db.Text
  createdByUserId   String?   @map("created_by_user_id")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scheduledReport ScheduledReport? @relation(fields: [scheduledReportId], references: [id], onDelete: SetNull)
  createdByUser   User?            @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, reportCode])
  @@index([scheduledReportId])
  @@index([status])
  @@index([startedAt])
  @@map("report_execution_logs")
}

model Notification {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  userId    String?   @map("user_id")
  type      String    @db.VarChar(50) // RISK_ALERT, SCHEDULED_REPORT, INTEGRATION_SYNC, SYSTEM
  title     String    @db.VarChar(255)
  message   String    @db.Text
  meta      Json?     @default("{}")
  is_read   Boolean   @default(false) @map("is_read")
  read_at   DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, is_read])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  userId         String   @map("user_id")
  email_enabled  Boolean  @default(true) @map("email_enabled")
  in_app_enabled Boolean  @default(true) @map("in_app_enabled")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId])
  @@index([tenantId])
  @@index([userId])
  @@map("notification_preferences")
}

model MessageThread {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  clientCompanyId String?   @map("client_company_id")
  subject         String?   @db.VarChar(255)
  lastMessageAt   DateTime? @map("last_message_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany?             @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  participants  MessageThreadParticipant[]
  messages      Message[]

  @@index([tenantId])
  @@index([tenantId, clientCompanyId])
  @@index([lastMessageAt])
  @@map("message_threads")
}

model MessageThreadParticipant {
  id         String    @id @default(cuid())
  threadId   String    @map("thread_id")
  userId     String    @map("user_id")
  lastReadAt DateTime? @map("last_read_at") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([threadId])
  @@index([userId])
  @@map("message_thread_participants")
}

model Message {
  id        String    @id @default(cuid())
  threadId  String    @map("thread_id")
  senderId  String    @map("sender_id")
  content   String    @db.Text
  readAt    DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User          @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model TenantSubscription {
  id         String    @id @default(cuid())
  tenantId   String    @unique @map("tenant_id")
  plan       String    @db.VarChar(50) // FREE, PRO, ENTERPRISE
  status     String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, PAST_DUE, CANCELLED
  validUntil DateTime? @map("valid_until") @db.Timestamptz(6)
  trialUntil DateTime? @map("trial_until") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([plan])
  @@index([status])
  @@map("tenant_subscriptions")
}

model TenantUsage {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  metric      String   @db.VarChar(50) // CLIENT_COMPANIES, DOCUMENTS, AI_ANALYSES, USERS, SCHEDULED_REPORTS
  periodStart DateTime @map("period_start") @db.Timestamptz(6)
  periodEnd   DateTime @map("period_end") @db.Timestamptz(6)
  value       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metric, periodStart])
  @@index([tenantId])
  @@index([tenantId, metric])
  @@index([periodStart, periodEnd])
  @@map("tenant_usages")
}

model SavedFilter {
  id        String   @id @default(cuid())
  tenantId  String   @map("tenant_id")
  userId    String   @map("user_id")
  name      String   @db.VarChar(255)
  target    String   @db.VarChar(50) // CLIENT_COMPANIES, INVOICES, DOCUMENTS, RISK_ALERTS, REPORTS
  filters   Json     @default("{}")
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([tenantId, userId, target])
  @@map("saved_filters")
}

model Task {
  id               String    @id @default(cuid())
  tenantId         String    @map("tenant_id")
  clientCompanyId  String?   @map("client_company_id")
  assignedToUserId String?   @map("assigned_to_user_id")
  title            String    @db.VarChar(255)
  description      String?   @db.Text
  status           String    @default("pending") @db.VarChar(50) // pending, in_progress, completed, cancelled
  priority         String    @default("medium") @db.VarChar(50) // low, medium, high
  dueDate          DateTime? @map("due_date") @db.Timestamptz(6)
  completedAt      DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  assignedTo    User?          @relation(fields: [assignedToUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, assignedToUserId])
  @@index([tenantId, status])
  @@index([tenantId, priority])
  @@index([dueDate])
  @@map("tasks")
}

model DocumentRequirement {
  id                 String   @id @default(cuid())
  tenantId           String   @map("tenant_id")
  clientCompanyId    String   @map("client_company_id")
  documentType       String   @map("document_type") @db.VarChar(50) // INVOICE, BANK_STATEMENT, RECEIPT, CONTRACT, etc.
  requiredByDate     DateTime @map("required_by_date") @db.Timestamptz(6)
  status             String   @default("pending") @db.VarChar(50) // pending, received, overdue
  receivedDocumentId String?  @map("received_document_id")
  description        String?  @db.Text
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant           Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany    ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  receivedDocument Document?     @relation(fields: [receivedDocumentId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, status])
  @@index([requiredByDate])
  @@map("document_requirements")
}

model RetryQueue {
  id          String   @id @default(cuid())
  tenantId    String?  @map("tenant_id")
  type        String   @db.VarChar(50) // email, job, sync
  payload     Json     @default("{}")
  attempts    Int      @default(0)
  maxAttempts Int      @default(3) @map("max_attempts")
  nextRetryAt DateTime @map("next_retry_at") @db.Timestamptz(6)
  status      String   @default("pending") @db.VarChar(50) // pending, processing, failed, success
  error       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([nextRetryAt])
  @@index([type])
  @@map("retry_queue")
}

model EmailLog {
  id          String    @id @default(cuid())
  tenantId    String?   @map("tenant_id")
  to          String[]  @db.VarChar(255)
  subject     String    @db.VarChar(500)
  status      String    @default("sent") @db.VarChar(50) // sent, delivered, bounced, failed
  messageId   String?   @map("message_id") @db.VarChar(255)
  error       String?   @db.Text
  openedAt    DateTime? @map("opened_at") @db.Timestamptz(6)
  clickedAt   DateTime? @map("clicked_at") @db.Timestamptz(6)
  bouncedAt   DateTime? @map("bounced_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

// ============================================================================
// MALI MÜŞAVIR PLATFORM - MASAK, KURGAN, Ba-Bs, Beyanname
// ============================================================================

// MASAK Suspicious Transaction Report (Şüpheli İşlem Bildirimi - SİB)
model MasakReport {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId   String    @map("client_company_id")
  reportType        String    @map("report_type") @db.VarChar(50) // STR (Suspicious Transaction Report), CTR (Cash Transaction Report)
  status            String    @default("draft") @db.VarChar(50) // draft, pending_review, submitted, acknowledged, investigation, closed
  suspicionType     String    @map("suspicion_type") @db.VarChar(100) // money_laundering, terrorism_financing, fraud, tax_evasion, structuring, other
  suspicionDetails  String    @map("suspicion_details") @db.Text
  transactionIds    Json      @default("[]") @map("transaction_ids") // Array of related transaction IDs
  invoiceIds        Json      @default("[]") @map("invoice_ids") // Array of related invoice IDs
  totalAmount       Decimal   @map("total_amount") @db.Decimal(15, 2)
  currency          String    @default("TRY") @db.VarChar(3)
  counterpartyName  String?   @map("counterparty_name") @db.VarChar(255)
  counterpartyTaxNo String?   @map("counterparty_tax_no") @db.VarChar(50)
  riskScore         Decimal?  @map("risk_score") @db.Decimal(5, 2) // 0-100
  riskIndicators    Json      @default("[]") @map("risk_indicators") // Array of triggered indicators
  detectedAt        DateTime  @map("detected_at") @db.Timestamptz(6)
  reportedAt        DateTime? @map("reported_at") @db.Timestamptz(6) // When submitted to MASAK
  filingReference   String?   @map("filing_reference") @db.VarChar(100) // MASAK reference number
  deadline          DateTime? @map("deadline") @db.Timestamptz(6) // 10 business days from detection
  notes             String?   @db.Text
  createdByUserId   String    @map("created_by_user_id")
  reviewedByUserId  String?   @map("reviewed_by_user_id")
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  createdBy     User          @relation("MasakReportCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  reviewedBy    User?         @relation("MasakReportReviewedBy", fields: [reviewedByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, suspicionType])
  @@index([status])
  @@index([detectedAt])
  @@index([deadline])
  @@map("masak_reports")
}

// KURGAN Risk Signal Monitor
model KurganSignal {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId   String    @map("client_company_id")
  signalType        String    @map("signal_type") @db.VarChar(100) // fake_invoice, income_mismatch, stock_discrepancy, vat_anomaly, profit_loss_anomaly, declaration_mismatch, cross_company_pattern
  severity          String    @db.VarChar(50) // low, medium, high, critical
  status            String    @default("new") @db.VarChar(50) // new, acknowledged, investigating, resolved, false_positive
  title             String    @db.VarChar(500)
  description       String    @db.Text
  dataSource        String    @map("data_source") @db.VarChar(100) // e_fatura, e_defter, bank_data, sgk, customs, ba_bs, beyanname
  affectedPeriod    String?   @map("affected_period") @db.VarChar(50) // e.g., "2026-01", "2025-Q4"
  riskScore         Decimal   @map("risk_score") @db.Decimal(5, 2) // 0-100
  financialImpact   Decimal?  @map("financial_impact") @db.Decimal(15, 2) // Estimated financial impact
  relatedInvoiceIds Json      @default("[]") @map("related_invoice_ids")
  relatedDocumentIds Json     @default("[]") @map("related_document_ids")
  recommendedAction String?   @map("recommended_action") @db.Text
  responseNotes     String?   @map("response_notes") @db.Text
  respondedAt       DateTime? @map("responded_at") @db.Timestamptz(6)
  respondedByUserId String?   @map("responded_by_user_id")
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  respondedBy   User?         @relation(fields: [respondedByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, signalType])
  @@index([tenantId, severity])
  @@index([status])
  @@index([createdAt])
  @@map("kurgan_signals")
}

// Ba-Bs Forms (Monthly Purchase/Sales Declarations)
model BaBsForm {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  clientCompanyId String    @map("client_company_id")
  formType        String    @map("form_type") @db.VarChar(10) // BA (purchases/alışlar) or BS (sales/satışlar)
  period          String    @db.VarChar(7) // Format: "YYYY-MM"
  status          String    @default("draft") @db.VarChar(50) // draft, generated, verified, submitted, accepted, rejected
  totalAmount     Decimal   @map("total_amount") @db.Decimal(15, 2)
  lineCount       Int       @map("line_count") @default(0)
  crossCheckStatus String?  @map("cross_check_status") @db.VarChar(50) // pending, matched, mismatched
  crossCheckErrors Json     @default("[]") @map("cross_check_errors") // Array of mismatch details
  submittedAt     DateTime? @map("submitted_at") @db.Timestamptz(6)
  filingReference String?   @map("filing_reference") @db.VarChar(100)
  generatedByUserId String? @map("generated_by_user_id")
  notes           String?   @db.Text
  metadata        Json?     @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany   @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  generatedBy   User?           @relation(fields: [generatedByUserId], references: [id], onDelete: SetNull)
  lines         BaBsFormLine[]

  @@unique([tenantId, clientCompanyId, formType, period])
  @@index([tenantId])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, period])
  @@index([tenantId, status])
  @@index([period])
  @@map("ba_bs_forms")
}

// Ba-Bs Form Line Items (per counterparty)
model BaBsFormLine {
  id                    String  @id @default(cuid())
  formId                String  @map("form_id")
  counterpartyName      String  @map("counterparty_name") @db.VarChar(255)
  counterpartyTaxNumber String  @map("counterparty_tax_number") @db.VarChar(50)
  counterpartyCountry   String  @default("TR") @map("counterparty_country") @db.VarChar(2)
  documentCount         Int     @map("document_count") @default(0)
  totalAmount           Decimal @map("total_amount") @db.Decimal(15, 2)
  crossCheckMatch       Boolean? @map("cross_check_match") // null=not checked, true=match, false=mismatch
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  form BaBsForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([counterpartyTaxNumber])
  @@map("ba_bs_form_lines")
}

// Tax Declaration (Beyanname) Preparation
model Beyanname {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId   String    @map("client_company_id")
  type              String    @db.VarChar(50) // KDV (VAT), MUHTASAR (Withholding), GECICI_VERGI (Quarterly), KURUMLAR (Corporate), GELIR (Income), DAMGA (Stamp), KDV2 (Reverse Charge VAT)
  period            String    @db.VarChar(10) // "YYYY-MM" for monthly, "YYYY-Q1" for quarterly, "YYYY" for annual
  status            String    @default("draft") @db.VarChar(50) // draft, calculating, calculated, reviewed, submitted, accepted, revision_needed
  dueDate           DateTime  @map("due_date") @db.Timestamptz(6)
  calculatedAmount  Decimal?  @map("calculated_amount") @db.Decimal(15, 2) // Tax amount to pay
  deductibleAmount  Decimal?  @map("deductible_amount") @db.Decimal(15, 2) // Deductible tax credits
  netPayable        Decimal?  @map("net_payable") @db.Decimal(15, 2) // Net tax to pay
  carryForward      Decimal?  @map("carry_forward") @db.Decimal(15, 2) // Devreden KDV (carried forward tax credit)
  calculationData   Json      @default("{}") @map("calculation_data") // Detailed calculation breakdown
  submittedAt       DateTime? @map("submitted_at") @db.Timestamptz(6)
  filingReference   String?   @map("filing_reference") @db.VarChar(100)
  preparedByUserId  String?   @map("prepared_by_user_id")
  reviewedByUserId  String?   @map("reviewed_by_user_id")
  notes             String?   @db.Text
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  preparedBy    User?         @relation("BeyannamePreparedBy", fields: [preparedByUserId], references: [id], onDelete: SetNull)
  reviewedBy    User?         @relation("BeyannameReviewedBy", fields: [reviewedByUserId], references: [id], onDelete: SetNull)

  @@unique([tenantId, clientCompanyId, type, period])
  @@index([tenantId])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([tenantId, dueDate])
  @@index([dueDate])
  @@index([period])
  @@map("beyannameler")
}

// Mali Müşavir Professional Profile (extends Tenant metadata)
model MaliMusavirProfile {
  id                  String    @id @default(cuid())
  tenantId            String    @unique @map("tenant_id")
  licenseType         String    @map("license_type") @db.VarChar(10) // SMMM, YMM
  licenseNumber       String    @map("license_number") @db.VarChar(50)
  turmobNumber        String?   @map("turmob_number") @db.VarChar(50) // TÜRMOB registration
  chamberName         String?   @map("chamber_name") @db.VarChar(255) // Oda adı
  specializations     Json      @default("[]") // ["vergi", "denetim", "muhasebe", "danismanlık"]
  insuranceProvider   String?   @map("insurance_provider") @db.VarChar(255)
  insuranceAmount     Decimal?  @map("insurance_amount") @db.Decimal(15, 2)
  insuranceExpiry     DateTime? @map("insurance_expiry") @db.Timestamptz(6)
  insurancePolicyNo   String?   @map("insurance_policy_no") @db.VarChar(100)
  cpdHoursCompleted   Decimal   @default(0) @map("cpd_hours_completed") @db.Decimal(5, 1) // Continuing Professional Development
  cpdPeriodStart      DateTime? @map("cpd_period_start") @db.Timestamptz(6)
  masakTrainingDate   DateTime? @map("masak_training_date") @db.Timestamptz(6) // Last MASAK compliance training
  totalActiveClients  Int       @default(0) @map("total_active_clients")
  metadata            Json?     @default("{}")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([licenseType])
  @@index([licenseNumber])
  @@map("mali_musavir_profiles")
}

// E-Defter (Electronic Ledger) Records
model EDefterLedger {
  id              String    @id
  tenantId        String    @map("tenant_id")
  clientCompanyId String    @map("client_company_id")
  periodStart     DateTime  @map("period_start") @db.Timestamptz(6)
  periodEnd       DateTime  @map("period_end") @db.Timestamptz(6)
  periodType      String    @map("period_type") @db.VarChar(20) // monthly, quarterly, yearly
  entryCount      Int       @default(0) @map("entry_count")
  totalDebit      Decimal   @map("total_debit") @db.Decimal(15, 2)
  totalCredit     Decimal   @map("total_credit") @db.Decimal(15, 2)
  generationDate  DateTime  @map("generation_date") @db.Timestamptz(6)
  status          String    @default("generated") @db.VarChar(50) // generated, submitted, accepted, rejected
  submissionId    String?   @map("submission_id") @db.VarChar(100)
  submissionDate  DateTime? @map("submission_date") @db.Timestamptz(6)
  auditTrail      Json      @default("[]") @map("audit_trail")
  metadata        Json?     @default("{}")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, clientCompanyId])
  @@index([tenantId, status])
  @@index([periodStart, periodEnd])
  @@map("e_defter_ledgers")
}

// ─── Recurring Invoices ──────────────────────────────────────────────────
model RecurringInvoice {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId   String    @map("client_company_id")
  templateName      String    @map("template_name") @db.VarChar(255)
  type              String    @db.VarChar(50) // SATIŞ, ALIŞ
  frequency         String    @db.VarChar(20) // weekly, monthly, quarterly, yearly
  dayOfMonth        Int?      @map("day_of_month") // 1-31 for monthly
  startDate         DateTime  @map("start_date") @db.Timestamptz(6)
  endDate           DateTime? @map("end_date") @db.Timestamptz(6)
  nextRunDate       DateTime  @map("next_run_date") @db.Timestamptz(6)
  lastRunDate       DateTime? @map("last_run_date") @db.Timestamptz(6)
  totalAmount       Decimal   @map("total_amount") @db.Decimal(15, 2)
  currency          String    @default("TRY") @db.VarChar(3)
  taxAmount         Decimal   @map("tax_amount") @db.Decimal(15, 2)
  counterpartyName  String?   @map("counterparty_name") @db.VarChar(255)
  counterpartyTaxNo String?   @map("counterparty_tax_no") @db.VarChar(50)
  lineItems         Json      @default("[]") @map("line_items") // InvoiceLine template data
  isActive          Boolean   @default(true) @map("is_active")
  autoSend          Boolean   @default(false) @map("auto_send") // Auto-send via e-fatura
  generatedCount    Int       @default(0) @map("generated_count")
  notes             String?   @db.Text
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([nextRunDate])
  @@map("recurring_invoices")
}

// ─── Check/Note (Çek/Senet) Tracking ─────────────────────────────────────
model CheckNote {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId   String?   @map("client_company_id")
  type              String    @db.VarChar(20) // CEK (check), SENET (promissory note)
  direction         String    @db.VarChar(20) // ALACAK (receivable), BORC (payable)
  documentNumber    String    @map("document_number") @db.VarChar(100)
  issuer            String?   @db.VarChar(255) // who issued the check/note
  bankName          String?   @map("bank_name") @db.VarChar(255)
  branchName        String?   @map("branch_name") @db.VarChar(255)
  amount            Decimal   @db.Decimal(15, 2)
  currency          String    @default("TRY") @db.VarChar(3)
  issueDate         DateTime  @map("issue_date") @db.Timestamptz(6)
  dueDate           DateTime  @map("due_date") @db.Timestamptz(6)
  endorsedTo        String?   @map("endorsed_to") @db.VarChar(255) // If endorsed to someone
  endorsedDate      DateTime? @map("endorsed_date") @db.Timestamptz(6)
  status            String    @default("portfoyde") @db.VarChar(50) // portfoyde, tahsile_verildi, tahsil_edildi, karsiligi_yok, iade_edildi, ciro_edildi
  collectedDate     DateTime? @map("collected_date") @db.Timestamptz(6)
  bouncedDate       DateTime? @map("bounced_date") @db.Timestamptz(6)
  notes             String?   @db.Text
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, type])
  @@index([tenantId, status])
  @@index([dueDate])
  @@map("check_notes")
}

// ─── Exchange Rate Tracking ──────────────────────────────────────────────
model ExchangeRate {
  id           String   @id @default(cuid())
  tenantId     String?  @map("tenant_id") // null = system-wide rate
  baseCurrency String   @map("base_currency") @db.VarChar(3) // e.g., USD
  quoteCurrency String  @map("quote_currency") @db.VarChar(3) // e.g., TRY
  buyRate      Decimal  @map("buy_rate") @db.Decimal(15, 6)
  sellRate     Decimal  @map("sell_rate") @db.Decimal(15, 6)
  midRate      Decimal  @map("mid_rate") @db.Decimal(15, 6)
  source       String   @default("TCMB") @db.VarChar(50) // TCMB, manual, bank
  rateDate     DateTime @map("rate_date") @db.Date
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([baseCurrency, quoteCurrency, rateDate, source])
  @@index([rateDate])
  @@index([baseCurrency, quoteCurrency])
  @@map("exchange_rates")
}

// ─── Payment Reminder ────────────────────────────────────────────────────
model PaymentReminder {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId   String?   @map("client_company_id")
  invoiceId         String?   @map("invoice_id")
  checkNoteId       String?   @map("check_note_id")
  type              String    @db.VarChar(30) // TAHSILAT (collection), ODEME (payment), CEK_VADESI (check due), SENET_VADESI (note due)
  dueDate           DateTime  @map("due_date") @db.Timestamptz(6)
  amount            Decimal   @db.Decimal(15, 2)
  currency          String    @default("TRY") @db.VarChar(3)
  description       String    @db.VarChar(500)
  reminderDaysBefore Int      @default(3) @map("reminder_days_before")
  reminderSent      Boolean   @default(false) @map("reminder_sent")
  reminderSentAt    DateTime? @map("reminder_sent_at") @db.Timestamptz(6)
  isPaid            Boolean   @default(false) @map("is_paid")
  paidAt            DateTime? @map("paid_at") @db.Timestamptz(6)
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  invoice       Invoice?       @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, dueDate])
  @@index([tenantId, isPaid])
  @@index([reminderSent, dueDate])
  @@map("payment_reminders")
}

// ─── Cash Flow Entry ─────────────────────────────────────────────────────
model CashFlowEntry {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  clientCompanyId   String?  @map("client_company_id")
  type              String   @db.VarChar(20) // INFLOW, OUTFLOW
  category          String   @db.VarChar(50) // invoice, salary, rent, tax, loan, other
  source            String   @db.VarChar(50) // actual, forecast
  amount            Decimal  @db.Decimal(15, 2)
  currency          String   @default("TRY") @db.VarChar(3)
  entryDate         DateTime @map("entry_date") @db.Date
  description       String?  @db.VarChar(500)
  invoiceId         String?  @map("invoice_id")
  checkNoteId       String?  @map("check_note_id")
  isRecurring       Boolean  @default(false) @map("is_recurring")
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, entryDate])
  @@index([tenantId, type])
  @@index([tenantId, source])
  @@map("cash_flow_entries")
}
