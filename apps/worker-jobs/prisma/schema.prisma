// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique @db.VarChar(255)
  hashedPassword String   @map("hashed_password") @db.VarChar(255)
  fullName      String    @map("full_name") @db.VarChar(255)
  locale        String    @default("tr-TR") @db.VarChar(10)
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  memberships             UserTenantMembership[]
  auditLogs               AuditLog[]
  userSettings            UserSettings?
  uploadedDocuments       Document[]
  resolvedRiskAlerts      RiskAlert[]
  passwordResetTokens     PasswordResetToken[]
  createdReportExecutions ReportExecutionLog[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]

  @@index([email])
  @@map("users")
}

model Tenant {
  id         String    @id @default(cuid())
  name       String    @db.VarChar(255)
  slug       String    @unique @db.VarChar(100)
  taxNumber  String?   @map("tax_number") @db.VarChar(50)
  phone      String?   @db.VarChar(50)
  email      String?   @db.VarChar(255)
  address    String?   @db.Text
  settings   Json?     @default("{}")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  memberships        UserTenantMembership[]
  auditLogs          AuditLog[]
  tenantSettings     TenantSettings?
  clientCompanies    ClientCompany[]
  invoices           Invoice[]
  transactions       Transaction[]
  ledgerAccounts     LedgerAccount[]
  bankAccounts       ClientCompanyBankAccount[]
  invoiceLines       InvoiceLine[]
  transactionLines   TransactionLine[]
  documents          Document[]
  documentProcessingJobs DocumentProcessingJob[]
  documentOCRResults DocumentOCRResult[]
  documentParsedData DocumentParsedData[]
  documentRiskFeatures DocumentRiskFeatures[]
  riskRules RiskRule[]
  documentRiskScores DocumentRiskScore[]
  clientCompanyRiskScores ClientCompanyRiskScore[]
  riskAlerts RiskAlert[]
  tenantIntegrations TenantIntegration[]
  integrationSyncJobs IntegrationSyncJob[]
  integrationSyncLogs IntegrationSyncLog[]
  tenantSubscription TenantSubscription?
  tenantUsages TenantUsage[]
  scheduledReports ScheduledReport[]
  reportExecutionLogs ReportExecutionLog[]
  notifications Notification[]
  notificationPreferences NotificationPreference[]

  @@index([slug])
  @@map("tenants")
}

model UserTenantMembership {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   @db.VarChar(50) // TenantOwner, Accountant, Staff, ReadOnly
  status    String   @default("active") @db.VarChar(50) // active, invited, suspended
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("user_tenant_memberships")
}

model AuditLog {
  id           String   @id @default(cuid())
  tenantId     String?  @map("tenant_id")
  userId       String?  @map("user_id")
  action       String   @db.VarChar(100) // LOGIN_SUCCESS, LOGIN_FAILED, etc.
  resourceType String?  @map("resource_type") @db.VarChar(100)
  resourceId   String?  @map("resource_id") @db.VarChar(255)
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  metadata     Json?    @default("{}")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([resourceId])
  @@index([createdAt])
  @@map("audit_logs")
}

model TenantSettings {
  id                 String   @id @default(cuid())
  tenantId           String   @unique @map("tenant_id")
  displayName        String?  @map("display_name") @db.VarChar(255)
  logoUrl            String?  @map("logo_url") @db.VarChar(500)
  locale             String   @default("tr-TR") @db.VarChar(10)
  timezone           String   @default("Europe/Istanbul") @db.VarChar(50)
  emailFromName      String?  @map("email_from_name") @db.VarChar(255)
  riskThresholds     Json     @default("{\"high\":70,\"critical\":90}") @map("risk_thresholds")
  defaultReportPeriod String   @default("LAST_30_DAYS") @map("default_report_period") @db.VarChar(50)
  createdAt          DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

model UserSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique @map("user_id")
  locale                    String?  @db.VarChar(10)
  timezone                  String?  @db.VarChar(50)
  emailNotificationsEnabled Boolean  @default(true) @map("email_notifications_enabled")
  inAppNotificationsEnabled Boolean  @default(true) @map("in_app_notifications_enabled")
  createdAt                 DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                 DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model ClientCompany {
  id                  String    @id @default(cuid())
  tenantId            String    @map("tenant_id")
  name                String    @db.VarChar(255)
  legalType           String    @map("legal_type") @db.VarChar(50) // Şahıs, Limited, Anonim
  taxNumber           String    @map("tax_number") @db.VarChar(50)
  tradeRegistryNumber String?   @map("trade_registry_number") @db.VarChar(50)
  sector              String?   @db.VarChar(255)
  contactPersonName   String?   @map("contact_person_name") @db.VarChar(255)
  contactPhone        String?   @map("contact_phone") @db.VarChar(50)
  contactEmail        String?   @map("contact_email") @db.VarChar(255)
  address             String?   @db.Text
  startDate           DateTime? @map("start_date") @db.Timestamptz(6)
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bankAccounts  ClientCompanyBankAccount[]
  invoices      Invoice[]
  transactions  Transaction[]
  documents     Document[]
  riskScores    ClientCompanyRiskScore[]
  riskAlerts    RiskAlert[]
  tenantIntegrations TenantIntegration[]
  integrationSyncJobs IntegrationSyncJob[]
  scheduledReports ScheduledReport[]

  @@unique([tenantId, taxNumber])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("client_companies")
}

model ClientCompanyBankAccount {
  id            String    @id @default(cuid())
  tenantId      String    @map("tenant_id")
  clientCompanyId String  @map("client_company_id")
  bankName      String    @map("bank_name") @db.VarChar(255)
  iban          String    @db.VarChar(34)
  accountNumber String?   @map("account_number") @db.VarChar(50)
  currency      String    @default("TRY") @db.VarChar(3)
  isPrimary     Boolean   @default(false) @map("is_primary")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientCompanyId])
  @@map("client_company_bank_accounts")
}

model Invoice {
  id                  String    @id @default(cuid())
  tenantId            String    @map("tenant_id")
  clientCompanyId     String    @map("client_company_id")
  externalId          String?   @map("external_id") @db.VarChar(255)
  type                String    @db.VarChar(50) // SATIŞ, ALIŞ
  issueDate           DateTime  @map("issue_date") @db.Timestamptz(6)
  dueDate             DateTime? @map("due_date") @db.Timestamptz(6)
  totalAmount         Decimal   @map("total_amount") @db.Decimal(15, 2)
  currency            String    @default("TRY") @db.VarChar(3)
  taxAmount           Decimal   @map("tax_amount") @db.Decimal(15, 2)
  netAmount           Decimal?   @map("net_amount") @db.Decimal(15, 2)
  counterpartyName    String?   @map("counterparty_name") @db.VarChar(255)
  counterpartyTaxNumber String? @map("counterparty_tax_number") @db.VarChar(50)
  status              String    @default("taslak") @db.VarChar(50) // taslak, kesildi, iptal, muhasebeleştirilmiş
  source              String    @default("manual") @db.VarChar(50) // manual, import, integration
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  lines         InvoiceLine[]
  relatedDocuments Document[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([tenantId, issueDate])
  @@index([tenantId, status])
  @@map("invoices")
}

model InvoiceLine {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  invoiceId   String   @map("invoice_id")
  lineNumber  Int      @map("line_number")
  description String   @db.VarChar(500)
  quantity    Decimal  @db.Decimal(15, 3)
  unitPrice   Decimal  @map("unit_price") @db.Decimal(15, 2)
  lineTotal   Decimal  @map("line_total") @db.Decimal(15, 2)
  vatRate     Decimal  @map("vat_rate") @db.Decimal(5, 4) // e.g. 0, 0.01, 0.18
  vatAmount   Decimal  @map("vat_amount") @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([invoiceId])
  @@map("invoice_lines")
}

model LedgerAccount {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  code      String    @db.VarChar(50)
  name      String    @db.VarChar(255)
  type      String    @db.VarChar(50) // asset, liability, equity, income, expense
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactionLines TransactionLine[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("ledger_accounts")
}

model Transaction {
  id            String    @id @default(cuid())
  tenantId      String    @map("tenant_id")
  clientCompanyId String? @map("client_company_id")
  externalId    String?   @map("external_id") @db.VarChar(255)
  date          DateTime  @db.Timestamptz(6)
  referenceNo   String?   @map("reference_no") @db.VarChar(100)
  description   String?   @db.Text
  source        String    @default("manual") @db.VarChar(50) // manual, import, integration
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany?   @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  lines         TransactionLine[]
  relatedDocuments Document[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([tenantId, date])
  @@index([tenantId, externalId])
  @@map("transactions")
}

model TransactionLine {
  id            String    @id @default(cuid())
  tenantId      String    @map("tenant_id")
  transactionId String    @map("transaction_id")
  ledgerAccountId String  @map("ledger_account_id")
  debitAmount   Decimal   @map("debit_amount") @db.Decimal(15, 2)
  creditAmount  Decimal   @map("credit_amount") @db.Decimal(15, 2)
  description   String?   @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transaction    Transaction     @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  ledgerAccount  LedgerAccount   @relation(fields: [ledgerAccountId], references: [id], onDelete: Restrict)

  @@index([tenantId])
  @@index([transactionId])
  @@index([ledgerAccountId])
  @@map("transaction_lines")
}

model Document {
  id                    String    @id @default(cuid())
  tenantId              String    @map("tenant_id")
  clientCompanyId       String    @map("client_company_id")
  relatedInvoiceId      String?   @map("related_invoice_id")
  relatedTransactionId  String?   @map("related_transaction_id")
  type                  String    @db.VarChar(50) // INVOICE, BANK_STATEMENT, RECEIPT, OTHER
  originalFileName      String    @map("original_file_name") @db.VarChar(500)
  storagePath           String    @map("storage_path") @db.VarChar(1000)
  mimeType              String    @map("mime_type") @db.VarChar(100)
  fileSizeBytes         BigInt    @map("file_size_bytes")
  uploadUserId          String    @map("upload_user_id")
  uploadSource          String    @default("manual") @map("upload_source") @db.VarChar(50) // manual, email_import, integration
  status                String    @default("UPLOADED") @db.VarChar(50) // UPLOADED, PROCESSING, PROCESSED, FAILED
  processingErrorMessage String?  @map("processing_error_message") @db.Text
  processedAt           DateTime? @map("processed_at") @db.Timestamptz(6)
  isDeleted             Boolean   @default(false) @map("is_deleted")
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  relatedInvoice Invoice?     @relation(fields: [relatedInvoiceId], references: [id], onDelete: SetNull)
  relatedTransaction Transaction? @relation(fields: [relatedTransactionId], references: [id], onDelete: SetNull)
  uploadUser    User          @relation(fields: [uploadUserId], references: [id], onDelete: Restrict)
  processingJob DocumentProcessingJob?
  ocrResult     DocumentOCRResult?
  parsedData    DocumentParsedData?
  riskFeatures  DocumentRiskFeatures?
  riskScore     DocumentRiskScore?
  riskAlerts    RiskAlert[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([tenantId, status])
  @@index([tenantId, isDeleted])
  @@index([tenantId, clientCompanyId, isDeleted])
  @@map("documents")
}

model DocumentProcessingJob {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  documentId      String    @unique @map("document_id")
  status          String    @default("PENDING") @db.VarChar(50) // PENDING, IN_PROGRESS, SUCCESS, FAILED
  attemptsCount   Int       @default(0) @map("attempts_count")
  lastErrorMessage String?  @map("last_error_message") @db.Text
  lastAttemptAt   DateTime? @map("last_attempt_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, status])
  @@map("document_processing_jobs")
}

model DocumentOCRResult {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  documentId  String   @unique @map("document_id")
  rawText     String   @map("raw_text") @db.Text
  ocrEngine   String   @map("ocr_engine") @db.VarChar(50) // stub, tesseract, textract, vision
  confidence  Decimal? @map("confidence") @db.Decimal(5, 4)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@map("document_ocr_results")
}

model DocumentParsedData {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  documentId    String   @unique @map("document_id")
  documentType  String   @map("document_type") @db.VarChar(50) // invoice, bank_statement, receipt, unknown
  fields        Json     @default("{}")
  parserVersion String   @map("parser_version") @db.VarChar(50) // 1.0-stub, 2.0-llm
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, documentType])
  @@map("document_parsed_data")
}

model DocumentRiskFeatures {
  id          String    @id @default(cuid())
  tenantId    String    @map("tenant_id")
  documentId  String    @unique @map("document_id")
  features    Json      @default("{}")
  riskFlags   Json      @default("[]")
  riskScore   Decimal?  @map("risk_score") @db.Decimal(5, 2)
  generatedAt DateTime  @map("generated_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([tenantId, riskScore])
  @@map("document_risk_features")
}

model RiskRule {
  id            String   @id @default(cuid())
  tenantId      String?  @map("tenant_id")
  scope         String   @db.VarChar(50) // document, company
  code          String   @db.VarChar(100)
  description   String   @db.VarChar(500)
  weight        Decimal  @db.Decimal(5, 2)
  isActive      Boolean  @default(true) @map("is_active")
  defaultSeverity String @map("default_severity") @db.VarChar(50) // low, medium, high
  config        Json?    @default("{}")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([scope])
  @@index([isActive])
  @@map("risk_rules")
}

model DocumentRiskScore {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  documentId        String   @unique @map("document_id")
  score             Decimal  @db.Decimal(5, 2) // 0-100
  severity          String   @db.VarChar(50) // low, medium, high
  triggeredRuleCodes Json    @default("[]") // Array of rule codes
  generatedAt       DateTime @map("generated_at") @db.Timestamptz(6)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([documentId])
  @@index([severity])
  @@index([tenantId, severity])
  @@index([generatedAt])
  @@map("document_risk_scores")
}

model ClientCompanyRiskScore {
  id                String   @id @default(cuid())
  tenantId          String   @map("tenant_id")
  clientCompanyId   String   @map("client_company_id")
  score             Decimal  @db.Decimal(5, 2) // 0-100
  severity          String   @db.VarChar(50) // low, medium, high
  triggeredRuleCodes Json    @default("[]") // Array of rule codes
  generatedAt       DateTime @map("generated_at") @db.Timestamptz(6)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([severity])
  @@index([tenantId, severity])
  @@index([generatedAt])
  @@map("client_company_risk_scores")
}

model RiskAlert {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  clientCompanyId  String?   @map("client_company_id")
  documentId       String?   @map("document_id")
  type             String    @db.VarChar(100) // RISK_THRESHOLD_EXCEEDED, ANOMALY_DETECTED
  title             String    @db.VarChar(255)
  message           String    @db.Text
  severity          String    @db.VarChar(50) // low, medium, high, critical
  status            String    @default("open") @db.VarChar(50) // open, in_progress, closed, ignored
  resolvedAt        DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolvedByUserId  String?   @map("resolved_by_user_id")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  document      Document?     @relation(fields: [documentId], references: [id], onDelete: SetNull)
  resolvedBy    User?         @relation(fields: [resolvedByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([documentId])
  @@index([status])
  @@index([severity])
  @@index([tenantId, status])
  @@index([tenantId, severity])
  @@index([createdAt])
  @@map("risk_alerts")
}

model IntegrationProvider {
  id            String    @id @default(cuid())
  type          String    @db.VarChar(50) // accounting, bank
  code          String    @unique @db.VarChar(100)
  name          String    @db.VarChar(255)
  description   String?   @db.Text
  isActive      Boolean   @default(true) @map("is_active")
  configSchema  Json?     @map("config_schema")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenantIntegrations TenantIntegration[]

  @@index([type])
  @@index([isActive])
  @@map("integration_providers")
}

model TenantIntegration {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  clientCompanyId String?   @map("client_company_id")
  providerId      String    @map("provider_id")
  status          String    @default("disconnected") @db.VarChar(50) // disconnected, connected, error
  displayName     String    @map("display_name") @db.VarChar(255)
  config          Json      @default("{}")
  lastSyncAt      DateTime? @map("last_sync_at") @db.Timestamptz(6)
  lastSyncStatus  String?   @map("last_sync_status") @db.VarChar(50) // success, error, in_progress
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany?      @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  provider      IntegrationProvider  @relation(fields: [providerId], references: [id], onDelete: Restrict)
  syncJobs      IntegrationSyncJob[]
  syncLogs      IntegrationSyncLog[]

  @@index([tenantId])
  @@index([clientCompanyId])
  @@index([providerId])
  @@index([tenantId, status])
  @@map("tenant_integrations")
}

model IntegrationSyncJob {
  id                  String    @id @default(cuid())
  tenantId            String    @map("tenant_id")
  clientCompanyId     String?   @map("client_company_id")
  tenantIntegrationId String    @map("tenant_integration_id")
  jobType             String    @map("job_type") @db.VarChar(50) // pull_invoices, pull_bank_transactions
  status              String    @default("pending") @db.VarChar(50) // pending, in_progress, success, failed
  startedAt           DateTime? @map("started_at") @db.Timestamptz(6)
  finishedAt          DateTime? @map("finished_at") @db.Timestamptz(6)
  errorMessage        String?   @map("error_message") @db.Text
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany     ClientCompany?    @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  tenantIntegration TenantIntegration @relation(fields: [tenantIntegrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantIntegrationId])
  @@index([tenantId, status])
  @@index([status])
  @@map("integration_sync_jobs")
}

model IntegrationSyncLog {
  id                  String    @id @default(cuid())
  tenantId            String    @map("tenant_id")
  tenantIntegrationId String    @map("tenant_integration_id")
  level               String    @db.VarChar(50) // info, warning, error
  message             String    @db.Text
  context             Json?     @default("{}")
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantIntegration TenantIntegration @relation(fields: [tenantIntegrationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantIntegrationId])
  @@index([tenantId, tenantIntegrationId])
  @@index([level])
  @@index([createdAt])
  @@map("integration_sync_logs")
}

model TenantSubscription {
  id         String    @id @default(cuid())
  tenantId   String    @unique @map("tenant_id")
  plan       String    @db.VarChar(50) // FREE, PRO, ENTERPRISE
  status     String    @default("ACTIVE") @db.VarChar(50) // ACTIVE, PAST_DUE, CANCELLED
  validUntil DateTime? @map("valid_until") @db.Timestamptz(6)
  trialUntil DateTime? @map("trial_until") @db.Timestamptz(6)
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([plan])
  @@index([status])
  @@map("tenant_subscriptions")
}

model TenantUsage {
  id          String   @id @default(cuid())
  tenantId    String   @map("tenant_id")
  metric      String   @db.VarChar(50) // CLIENT_COMPANIES, DOCUMENTS, AI_ANALYSES, USERS, SCHEDULED_REPORTS
  periodStart DateTime @map("period_start") @db.Timestamptz(6)
  periodEnd   DateTime @map("period_end") @db.Timestamptz(6)
  value       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, metric, periodStart])
  @@index([tenantId])
  @@index([tenantId, metric])
  @@index([periodStart, periodEnd])
  @@map("tenant_usages")
}

model ReportDefinition {
  id          String   @id @default(cuid())
  code        String   @unique @db.VarChar(100)
  name        String   @db.VarChar(255)
  description String?  @db.Text
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([isActive])
  @@map("report_definitions")
}

model ScheduledReport {
  id              String    @id @default(cuid())
  tenantId        String    @map("tenant_id")
  reportCode      String    @map("report_code") @db.VarChar(100)
  clientCompanyId String?   @map("client_company_id")
  name            String    @db.VarChar(255)
  format          String    @db.VarChar(50) // "pdf" | "excel" (string for now)
  scheduleCron    String    @map("schedule_cron") @db.VarChar(100) // "daily" | "weekly" | "monthly" or cron-like
  filters         Json?     @default("{}")
  recipients      Json?     @default("[]") // array of emails
  isActive        Boolean   @default(true) @map("is_active")
  lastRunAt       DateTime? @map("last_run_at") @db.Timestamptz(6)
  lastRunStatus   String?   @map("last_run_status") @db.VarChar(50) // "success" | "failed" | null
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant        Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientCompany ClientCompany?       @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  executionLogs ReportExecutionLog[]

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([reportCode])
  @@map("scheduled_reports")
}

model ReportExecutionLog {
  id                String    @id @default(cuid())
  tenantId          String    @map("tenant_id")
  scheduledReportId String?   @map("scheduled_report_id")
  reportCode        String    @map("report_code") @db.VarChar(100)
  startedAt         DateTime  @default(now()) @map("started_at") @db.Timestamptz(6)
  finishedAt        DateTime? @map("finished_at") @db.Timestamptz(6)
  status            String    @db.VarChar(50) // "success" | "failed"
  message           String?   @db.Text
  createdByUserId   String?   @map("created_by_user_id")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scheduledReport ScheduledReport? @relation(fields: [scheduledReportId], references: [id], onDelete: SetNull)
  createdByUser   User?            @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, reportCode])
  @@index([scheduledReportId])
  @@index([status])
  @@index([startedAt])
  @@map("report_execution_logs")
}

model Notification {
  id        String    @id @default(cuid())
  tenantId  String    @map("tenant_id")
  userId    String?   @map("user_id")
  type      String    @db.VarChar(50) // RISK_ALERT, SCHEDULED_REPORT, INTEGRATION_SYNC, SYSTEM
  title     String    @db.VarChar(255)
  message   String    @db.Text
  meta      Json?     @default("{}")
  is_read   Boolean   @default(false) @map("is_read")
  read_at   DateTime? @map("read_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, userId])
  @@index([tenantId, is_read])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id            String   @id @default(cuid())
  tenantId      String   @map("tenant_id")
  userId        String   @map("user_id")
  type          String   @db.VarChar(50) // RISK_ALERT, SCHEDULED_REPORT, etc.
  email_enabled Boolean  @default(true) @map("email_enabled")
  in_app_enabled Boolean @default(true) @map("in_app_enabled")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, userId, type])
  @@index([tenantId])
  @@index([userId])
  @@map("notification_preferences")
}

